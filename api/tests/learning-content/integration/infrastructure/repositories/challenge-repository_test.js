import { challengeRepository } from '../../../../../src/learning-content/infrastructure/repositories/challenge-repository.js';
import { databaseBuilder, expect, knex } from '../../../../test-helper.js';

describe('Learning Content | Integration | Repositories | Challenge', function () {
  afterEach(async function () {
    await knex('learningcontent.challenges').truncate();
  });

  describe('#saveMany', function () {
    it('should insert challenges', async function () {
      // given
      const challengeDtos = [
        {
          id: 'challengeIdA',
          instruction: 'instruction Epreuve A',
          alternativeInstruction: 'alternativeInstruction Epreuve A',
          proposals: 'proposals Epreuve A',
          type: 'QCU',
          solution: 'solution Epreuve A',
          solutionToDisplay: 'solutionToDisplay Epreuve A',
          t1Status: true,
          t2Status: true,
          t3Status: true,
          status: 'archivé',
          genealogy: 'genealogy Epreuve A',
          accessibility1: 'accessibility1 Epreuve A',
          accessibility2: 'accessibility2 Epreuve B',
          requireGafamWebsiteAccess: true,
          isIncompatibleIpadCertif: true,
          deafAndHardOfHearing: 'deafAndHardOfHearing Epreuve A',
          isAwarenessChallenge: true,
          toRephrase: true,
          alternativeVersion: 8,
          shuffled: true,
          illustrationAlt: 'illustrationAlt Epreuve A',
          illustrationUrl: 'illustrationUrl Epreuve A',
          attachments: ['attachment1', 'attachment2'],
          responsive: 'responsive Epreuve A',
          alpha: 1.1,
          delta: 3.3,
          autoReply: true,
          focusable: true,
          format: 'format Epreuve A',
          timer: 180,
          embedHeight: 800,
          embedUrl: 'embedUrl Epreuve A',
          embedTitle: 'embedTitle Epreuve A',
          locales: ['fr'],
          competenceId: 'competenceIdA',
          skillId: 'skillIdA',
        },
        {
          id: 'challengeIdB',
          instruction: 'instruction Epreuve B',
          alternativeInstruction: 'alternativeInstruction Epreuve B',
          proposals: 'proposals Epreuve B',
          type: 'QCU',
          solution: 'solution Epreuve B',
          solutionToDisplay: 'solutionToDisplay Epreuve B',
          t1Status: true,
          t2Status: true,
          t3Status: true,
          status: 'validé',
          genealogy: 'genealogy Epreuve B',
          accessibility1: 'accessibility1 Epreuve B',
          accessibility2: 'accessibility2 Epreuve B',
          requireGafamWebsiteAccess: true,
          isIncompatibleIpadCertif: false,
          deafAndHardOfHearing: 'deafAndHardOfHearing Epreuve B',
          isAwarenessChallenge: false,
          toRephrase: true,
          alternativeVersion: 5,
          shuffled: true,
          illustrationAlt: 'illustrationAlt Epreuve B',
          illustrationUrl: 'illustrationUrl Epreuve B',
          attachments: ['attachment1'],
          responsive: 'responsive Epreuve B',
          alpha: 1.0,
          delta: 4.0,
          autoReply: false,
          focusable: false,
          format: 'format Epreuve B',
          timer: null,
          embedHeight: 200,
          embedUrl: 'embedUrl Epreuve B',
          embedTitle: 'embedTitle Epreuve B',
          locales: ['en', 'nl'],
          competenceId: 'competenceIdB',
          skillId: 'skillIdB',
        },
        {
          id: 'challengeIdC',
          instruction: 'instruction Epreuve C',
          alternativeInstruction: 'alternativeInstruction Epreuve C',
          proposals: 'proposals Epreuve C',
          type: 'QCM',
          solution: 'solution Epreuve C',
          solutionToDisplay: 'solutionToDisplay Epreuve C',
          t1Status: true,
          t2Status: false,
          t3Status: true,
          status: 'périmé',
          genealogy: 'genealogy Epreuve C',
          accessibility1: 'accessibility1 Epreuve C',
          accessibility2: 'accessibility2 Epreuve C',
          requireGafamWebsiteAccess: false,
          isIncompatibleIpadCertif: false,
          deafAndHardOfHearing: 'deafAndHardOfHearing Epreuve C',
          isAwarenessChallenge: false,
          toRephrase: true,
          alternativeVersion: 5,
          shuffled: true,
          illustrationAlt: 'illustrationAlt Epreuve C',
          illustrationUrl: 'illustrationUrl Epreuve C',
          attachments: ['attachment1'],
          responsive: 'responsive Epreuve C',
          alpha: 1.0,
          delta: 5.0,
          autoReply: false,
          focusable: true,
          format: 'format Epreuve C',
          timer: null,
          embedHeight: 200,
          embedUrl: 'embedUrl Epreuve C',
          embedTitle: 'embedTitle Epreuve C',
          locales: ['en'],
          competenceId: 'competenceIdC',
          skillId: 'skillIdC',
        },
      ];

      // when
      await challengeRepository.saveMany(challengeDtos);

      // then
      const savedChallenges = await knex.select('*').from('learningcontent.challenges').orderBy('id');

      expect(savedChallenges).to.deep.equal([
        {
          id: 'challengeIdA',
          instruction: 'instruction Epreuve A',
          alternativeInstruction: 'alternativeInstruction Epreuve A',
          proposals: 'proposals Epreuve A',
          type: 'QCU',
          solution: 'solution Epreuve A',
          solutionToDisplay: 'solutionToDisplay Epreuve A',
          t1Status: true,
          t2Status: true,
          t3Status: true,
          status: 'archivé',
          genealogy: 'genealogy Epreuve A',
          accessibility1: 'accessibility1 Epreuve A',
          accessibility2: 'accessibility2 Epreuve B',
          requireGafamWebsiteAccess: true,
          isIncompatibleIpadCertif: true,
          deafAndHardOfHearing: 'deafAndHardOfHearing Epreuve A',
          isAwarenessChallenge: true,
          toRephrase: true,
          alternativeVersion: 8,
          shuffled: true,
          illustrationAlt: 'illustrationAlt Epreuve A',
          illustrationUrl: 'illustrationUrl Epreuve A',
          attachments: ['attachment1', 'attachment2'],
          responsive: 'responsive Epreuve A',
          alpha: 1.1,
          delta: 3.3,
          autoReply: true,
          focusable: true,
          format: 'format Epreuve A',
          timer: 180,
          embedHeight: 800,
          embedUrl: 'embedUrl Epreuve A',
          embedTitle: 'embedTitle Epreuve A',
          locales: ['fr'],
          competenceId: 'competenceIdA',
          skillId: 'skillIdA',
        },
        {
          id: 'challengeIdB',
          instruction: 'instruction Epreuve B',
          alternativeInstruction: 'alternativeInstruction Epreuve B',
          proposals: 'proposals Epreuve B',
          type: 'QCU',
          solution: 'solution Epreuve B',
          solutionToDisplay: 'solutionToDisplay Epreuve B',
          t1Status: true,
          t2Status: true,
          t3Status: true,
          status: 'validé',
          genealogy: 'genealogy Epreuve B',
          accessibility1: 'accessibility1 Epreuve B',
          accessibility2: 'accessibility2 Epreuve B',
          requireGafamWebsiteAccess: true,
          isIncompatibleIpadCertif: false,
          deafAndHardOfHearing: 'deafAndHardOfHearing Epreuve B',
          isAwarenessChallenge: false,
          toRephrase: true,
          alternativeVersion: 5,
          shuffled: true,
          illustrationAlt: 'illustrationAlt Epreuve B',
          illustrationUrl: 'illustrationUrl Epreuve B',
          attachments: ['attachment1'],
          responsive: 'responsive Epreuve B',
          alpha: 1.0,
          delta: 4.0,
          autoReply: false,
          focusable: false,
          format: 'format Epreuve B',
          timer: null,
          embedHeight: 200,
          embedUrl: 'embedUrl Epreuve B',
          embedTitle: 'embedTitle Epreuve B',
          locales: ['en', 'nl'],
          competenceId: 'competenceIdB',
          skillId: 'skillIdB',
        },
        {
          id: 'challengeIdC',
          instruction: 'instruction Epreuve C',
          alternativeInstruction: 'alternativeInstruction Epreuve C',
          proposals: 'proposals Epreuve C',
          type: 'QCM',
          solution: 'solution Epreuve C',
          solutionToDisplay: 'solutionToDisplay Epreuve C',
          t1Status: true,
          t2Status: false,
          t3Status: true,
          status: 'périmé',
          genealogy: 'genealogy Epreuve C',
          accessibility1: 'accessibility1 Epreuve C',
          accessibility2: 'accessibility2 Epreuve C',
          requireGafamWebsiteAccess: false,
          isIncompatibleIpadCertif: false,
          deafAndHardOfHearing: 'deafAndHardOfHearing Epreuve C',
          isAwarenessChallenge: false,
          toRephrase: true,
          alternativeVersion: 5,
          shuffled: true,
          illustrationAlt: 'illustrationAlt Epreuve C',
          illustrationUrl: 'illustrationUrl Epreuve C',
          attachments: ['attachment1'],
          responsive: 'responsive Epreuve C',
          alpha: 1.0,
          delta: 5.0,
          autoReply: false,
          focusable: true,
          format: 'format Epreuve C',
          timer: null,
          embedHeight: 200,
          embedUrl: 'embedUrl Epreuve C',
          embedTitle: 'embedTitle Epreuve C',
          locales: ['en'],
          competenceId: 'competenceIdC',
          skillId: 'skillIdC',
        },
      ]);
    });

    describe('when some challenges already exist', function () {
      it('should upsert challenges and keep missing ones', async function () {
        // given
        databaseBuilder.factory.learningContent.buildChallenge({
          id: 'challengeIdA',
          instruction: 'instruction Epreuve A',
          alternativeInstruction: 'alternativeInstruction Epreuve A',
          proposals: 'proposals Epreuve A',
          type: 'QCU',
          solution: 'solution Epreuve A',
          solutionToDisplay: 'solutionToDisplay Epreuve A',
          t1Status: true,
          t2Status: true,
          t3Status: true,
          status: 'archivé',
          genealogy: 'genealogy Epreuve A',
          accessibility1: 'accessibility1 Epreuve A',
          accessibility2: 'accessibility2 Epreuve B',
          requireGafamWebsiteAccess: true,
          isIncompatibleIpadCertif: true,
          deafAndHardOfHearing: 'deafAndHardOfHearing Epreuve A',
          isAwarenessChallenge: true,
          toRephrase: true,
          alternativeVersion: 8,
          shuffled: true,
          illustrationAlt: 'illustrationAlt Epreuve A',
          illustrationUrl: 'illustrationUrl Epreuve A',
          attachments: ['attachment1', 'attachment2'],
          responsive: 'responsive Epreuve A',
          alpha: 1.1,
          delta: 3.3,
          autoReply: true,
          focusable: true,
          format: 'format Epreuve A',
          timer: 180,
          embedHeight: 800,
          embedUrl: 'embedUrl Epreuve A',
          embedTitle: 'embedTitle Epreuve A',
          locales: ['fr'],
          competenceId: 'competenceIdA',
          skillId: 'skillIdA',
        });
        databaseBuilder.factory.learningContent.buildChallenge({
          id: 'challengeIdB',
          instruction: 'instruction Epreuve B',
          alternativeInstruction: 'alternativeInstruction Epreuve B',
          proposals: 'proposals Epreuve B',
          type: 'QCU',
          solution: 'solution Epreuve B',
          solutionToDisplay: 'solutionToDisplay Epreuve B',
          t1Status: true,
          t2Status: true,
          t3Status: true,
          status: 'validé',
          genealogy: 'genealogy Epreuve B',
          accessibility1: 'accessibility1 Epreuve B',
          accessibility2: 'accessibility2 Epreuve B',
          requireGafamWebsiteAccess: true,
          isIncompatibleIpadCertif: false,
          deafAndHardOfHearing: 'deafAndHardOfHearing Epreuve B',
          isAwarenessChallenge: false,
          toRephrase: true,
          alternativeVersion: 5,
          shuffled: true,
          illustrationAlt: 'illustrationAlt Epreuve B',
          illustrationUrl: 'illustrationUrl Epreuve B',
          attachments: ['attachment1'],
          responsive: 'responsive Epreuve B',
          alpha: 1.0,
          delta: 4.0,
          autoReply: false,
          focusable: false,
          format: 'format Epreuve B',
          timer: null,
          embedHeight: 200,
          embedUrl: 'embedUrl Epreuve B',
          embedTitle: 'embedTitle Epreuve B',
          locales: ['en', 'nl'],
          competenceId: 'competenceIdB',
          skillId: 'skillIdB',
        });
        await databaseBuilder.commit();

        const challengeDtos = [
          {
            id: 'challengeIdA',
            instruction: 'instruction Epreuve A modified',
            alternativeInstruction: 'alternativeInstruction Epreuve A modified',
            proposals: 'proposals Epreuve A modified',
            type: 'QCU modified',
            solution: 'solution Epreuve A modified',
            solutionToDisplay: 'solutionToDisplay Epreuve A modified',
            t1Status: false,
            t2Status: false,
            t3Status: false,
            status: 'archivé  modified',
            genealogy: 'genealogy Epreuve A  modified',
            accessibility1: 'accessibility1 Epreuve A modified',
            accessibility2: 'accessibility2 Epreuve A modified',
            requireGafamWebsiteAccess: false,
            isIncompatibleIpadCertif: false,
            deafAndHardOfHearing: 'deafAndHardOfHearing Epreuve A modified',
            isAwarenessChallenge: false,
            toRephrase: true,
            alternativeVersion: 11,
            shuffled: true,
            illustrationAlt: 'illustrationAlt Epreuve A modified',
            illustrationUrl: 'illustrationUrl Epreuve A modified',
            attachments: ['attachment4', 'attachment2', 'attachment3'],
            responsive: 'responsive Epreuve A modified',
            alpha: 8.0,
            delta: 90.5,
            autoReply: false,
            focusable: false,
            format: 'format Epreuve A modified',
            timer: 250,
            embedHeight: 1800,
            embedUrl: 'embedUrl Epreuve A modified',
            embedTitle: 'embedTitle Epreuve A modified',
            locales: ['fr', 'fr-fr'],
            competenceId: 'competenceIdA modified',
            skillId: 'skillIdA modified',
          },
          {
            id: 'challengeIdC',
            instruction: 'instruction Epreuve C',
            alternativeInstruction: 'alternativeInstruction Epreuve C',
            proposals: 'proposals Epreuve C',
            type: 'QCM',
            solution: 'solution Epreuve C',
            solutionToDisplay: 'solutionToDisplay Epreuve C',
            t1Status: true,
            t2Status: false,
            t3Status: true,
            status: 'périmé',
            genealogy: 'genealogy Epreuve C',
            accessibility1: 'accessibility1 Epreuve C',
            accessibility2: 'accessibility2 Epreuve C',
            requireGafamWebsiteAccess: false,
            isIncompatibleIpadCertif: false,
            deafAndHardOfHearing: 'deafAndHardOfHearing Epreuve C',
            isAwarenessChallenge: false,
            toRephrase: true,
            alternativeVersion: 5,
            shuffled: true,
            illustrationAlt: 'illustrationAlt Epreuve C',
            illustrationUrl: 'illustrationUrl Epreuve C',
            attachments: ['attachment1'],
            responsive: 'responsive Epreuve C',
            alpha: 1.0,
            delta: 5.0,
            autoReply: false,
            focusable: true,
            format: 'format Epreuve C',
            timer: null,
            embedHeight: 200,
            embedUrl: 'embedUrl Epreuve C',
            embedTitle: 'embedTitle Epreuve C',
            locales: ['en'],
            competenceId: 'competenceIdC',
            skillId: 'skillIdC',
          },
        ];

        // when
        await challengeRepository.saveMany(challengeDtos);

        // then
        const savedChallenges = await knex.select('*').from('learningcontent.challenges').orderBy('id');

        expect(savedChallenges).to.deep.equal([
          {
            id: 'challengeIdA',
            instruction: 'instruction Epreuve A modified',
            alternativeInstruction: 'alternativeInstruction Epreuve A modified',
            proposals: 'proposals Epreuve A modified',
            type: 'QCU modified',
            solution: 'solution Epreuve A modified',
            solutionToDisplay: 'solutionToDisplay Epreuve A modified',
            t1Status: false,
            t2Status: false,
            t3Status: false,
            status: 'archivé  modified',
            genealogy: 'genealogy Epreuve A  modified',
            accessibility1: 'accessibility1 Epreuve A modified',
            accessibility2: 'accessibility2 Epreuve A modified',
            requireGafamWebsiteAccess: false,
            isIncompatibleIpadCertif: false,
            deafAndHardOfHearing: 'deafAndHardOfHearing Epreuve A modified',
            isAwarenessChallenge: false,
            toRephrase: true,
            alternativeVersion: 11,
            shuffled: true,
            illustrationAlt: 'illustrationAlt Epreuve A modified',
            illustrationUrl: 'illustrationUrl Epreuve A modified',
            attachments: ['attachment4', 'attachment2', 'attachment3'],
            responsive: 'responsive Epreuve A modified',
            alpha: 8.0,
            delta: 90.5,
            autoReply: false,
            focusable: false,
            format: 'format Epreuve A modified',
            timer: 250,
            embedHeight: 1800,
            embedUrl: 'embedUrl Epreuve A modified',
            embedTitle: 'embedTitle Epreuve A modified',
            locales: ['fr', 'fr-fr'],
            competenceId: 'competenceIdA modified',
            skillId: 'skillIdA modified',
          },
          {
            id: 'challengeIdB',
            instruction: 'instruction Epreuve B',
            alternativeInstruction: 'alternativeInstruction Epreuve B',
            proposals: 'proposals Epreuve B',
            type: 'QCU',
            solution: 'solution Epreuve B',
            solutionToDisplay: 'solutionToDisplay Epreuve B',
            t1Status: true,
            t2Status: true,
            t3Status: true,
            status: 'validé',
            genealogy: 'genealogy Epreuve B',
            accessibility1: 'accessibility1 Epreuve B',
            accessibility2: 'accessibility2 Epreuve B',
            requireGafamWebsiteAccess: true,
            isIncompatibleIpadCertif: false,
            deafAndHardOfHearing: 'deafAndHardOfHearing Epreuve B',
            isAwarenessChallenge: false,
            toRephrase: true,
            alternativeVersion: 5,
            shuffled: true,
            illustrationAlt: 'illustrationAlt Epreuve B',
            illustrationUrl: 'illustrationUrl Epreuve B',
            attachments: ['attachment1'],
            responsive: 'responsive Epreuve B',
            alpha: 1.0,
            delta: 4.0,
            autoReply: false,
            focusable: false,
            format: 'format Epreuve B',
            timer: null,
            embedHeight: 200,
            embedUrl: 'embedUrl Epreuve B',
            embedTitle: 'embedTitle Epreuve B',
            locales: ['en', 'nl'],
            competenceId: 'competenceIdB',
            skillId: 'skillIdB',
          },
          {
            id: 'challengeIdC',
            instruction: 'instruction Epreuve C',
            alternativeInstruction: 'alternativeInstruction Epreuve C',
            proposals: 'proposals Epreuve C',
            type: 'QCM',
            solution: 'solution Epreuve C',
            solutionToDisplay: 'solutionToDisplay Epreuve C',
            t1Status: true,
            t2Status: false,
            t3Status: true,
            status: 'périmé',
            genealogy: 'genealogy Epreuve C',
            accessibility1: 'accessibility1 Epreuve C',
            accessibility2: 'accessibility2 Epreuve C',
            requireGafamWebsiteAccess: false,
            isIncompatibleIpadCertif: false,
            deafAndHardOfHearing: 'deafAndHardOfHearing Epreuve C',
            isAwarenessChallenge: false,
            toRephrase: true,
            alternativeVersion: 5,
            shuffled: true,
            illustrationAlt: 'illustrationAlt Epreuve C',
            illustrationUrl: 'illustrationUrl Epreuve C',
            attachments: ['attachment1'],
            responsive: 'responsive Epreuve C',
            alpha: 1.0,
            delta: 5.0,
            autoReply: false,
            focusable: true,
            format: 'format Epreuve C',
            timer: null,
            embedHeight: 200,
            embedUrl: 'embedUrl Epreuve C',
            embedTitle: 'embedTitle Epreuve C',
            locales: ['en'],
            competenceId: 'competenceIdC',
            skillId: 'skillIdC',
          },
        ]);
      });
    });
  });
});
